
import React, { useState } from 'react';
import { useStore } from '../context/StoreContext';
import { MessageCircle, Clock, Plus, Hash, ChevronRight, ArrowLeft, User } from 'lucide-react';
import { Link } from 'react-router-dom';

const Forums: React.FC = () => {
  const { threads, forumCategories, getUser, addThread, addForumCategory, currentUser } = useStore();
  
  // View State: 'index' (Categories) or 'category' (List of Threads)
  const [activeCategory, setActiveCategory] = useState<string | null>(null);
  
  // Creation State
  const [isCreatingThread, setIsCreatingThread] = useState(false);
  const [isCreatingCategory, setIsCreatingCategory] = useState(false);
  
  // Thread Form
  const [newTitle, setNewTitle] = useState('');
  const [newContent, setNewContent] = useState('');
  
  // Category Form (Mods only)
  const [newCatTitle, setNewCatTitle] = useState('');
  const [newCatDesc, setNewCatDesc] = useState('');

  const handleThreadSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if(!newTitle.trim() || !newContent.trim() || !activeCategory) return;
    addThread(newTitle, newContent, activeCategory);
    setIsCreatingThread(false);
    setNewTitle('');
    setNewContent('');
  };

  const handleCategorySubmit = (e: React.FormEvent) => {
      e.preventDefault();
      if(!newCatTitle.trim()) return;
      addForumCategory(newCatTitle, newCatDesc);
      setIsCreatingCategory(false);
      setNewCatTitle('');
      setNewCatDesc('');
  }

  const filteredThreads = activeCategory ? threads.filter(t => t.categoryId === activeCategory) : [];
  const currentCategoryData = forumCategories.find(c => c.id === activeCategory);

  // ---------------------------------------------------------------------------
  // VIEW 1: CATEGORY INDEX
  // ---------------------------------------------------------------------------
  if (!activeCategory) {
      return (
          <div className="max-w-5xl mx-auto space-y-8">
              {/* Header */}
              <div className="flex justify-between items-center bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-900">Community Forums</h1>
                      <p className="text-gray-500">Join the discussion with Akita owners and breeders worldwide.</p>
                  </div>
                  {currentUser.isModerator && (
                      <button 
                        onClick={() => setIsCreatingCategory(!isCreatingCategory)}
                        className="bg-gray-900 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-800 flex items-center"
                      >
                          {isCreatingCategory ? 'Cancel' : 'Add Category'}
                      </button>
                  )}
              </div>

              {/* Mod Tool: Create Category */}
              {isCreatingCategory && (
                  <div className="bg-gray-50 border border-gray-200 p-6 rounded-lg shadow-inner">
                      <h3 className="font-bold text-gray-800 mb-4">Create New Board (Moderator)</h3>
                      <form onSubmit={handleCategorySubmit} className="space-y-4 max-w-md">
                          <div>
                              <label className="block text-sm font-medium text-gray-700">Board Title</label>
                              <input required type="text" value={newCatTitle} onChange={e => setNewCatTitle(e.target.value)} className="mt-1 block w-full border border-gray-300 rounded-md p-2" />
                          </div>
                          <div>
                              <label className="block text-sm font-medium text-gray-700">Description</label>
                              <input type="text" value={newCatDesc} onChange={e => setNewCatDesc(e.target.value)} className="mt-1 block w-full border border-gray-300 rounded-md p-2" />
                          </div>
                          <button type="submit" className="bg-brand-600 text-white px-4 py-2 rounded-md text-sm font-medium">Create Board</button>
                      </form>
                  </div>
              )}

              {/* Categories Grid */}
              <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                  <div className="bg-gray-50 px-6 py-3 border-b border-gray-200 flex text-xs font-bold text-gray-500 uppercase tracking-wider">
                      <div className="flex-1">Board</div>
                      <div className="w-24 text-center hidden sm:block">Topics</div>
                      <div className="w-48 text-right hidden sm:block">Last Post</div>
                  </div>
                  <div className="divide-y divide-gray-100">
                      {forumCategories.map(cat => {
                          // Stats
                          const catThreads = threads.filter(t => t.categoryId === cat.id);
                          const lastActiveThread = catThreads.sort((a,b) => b.lastActive - a.lastActive)[0];

                          return (
                              <div 
                                key={cat.id} 
                                onClick={() => setActiveCategory(cat.id)}
                                className="px-6 py-4 hover:bg-gray-50 cursor-pointer transition flex items-center"
                              >
                                  <div className="flex-1 pr-4">
                                      <div className="flex items-center mb-1">
                                         <div className="p-2 bg-brand-100 rounded-lg mr-3 text-brand-600">
                                             <Hash className="w-5 h-5" />
                                         </div>
                                         <div>
                                             <h3 className="text-lg font-bold text-gray-900 hover:text-brand-600">{cat.title}</h3>
                                             <p className="text-sm text-gray-500">{cat.description}</p>
                                         </div>
                                      </div>
                                  </div>
                                  <div className="w-24 text-center hidden sm:block">
                                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                          {catThreads.length}
                                      </span>
                                  </div>
                                  <div className="w-48 text-right hidden sm:block pl-4">
                                      {lastActiveThread ? (
                                          <div className="text-sm">
                                              <p className="font-medium text-gray-900 truncate w-full">{lastActiveThread.title}</p>
                                              <p className="text-xs text-gray-500">{new Date(lastActiveThread.lastActive).toLocaleDateString()}</p>
                                          </div>
                                      ) : (
                                          <span className="text-xs text-gray-400 italic">No posts yet</span>
                                      )}
                                  </div>
                                  <div className="pl-4 sm:hidden">
                                      <ChevronRight className="w-5 h-5 text-gray-400" />
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              </div>
          </div>
      );
  }

  // ---------------------------------------------------------------------------
  // VIEW 2: THREAD LIST (Topic View)
  // ---------------------------------------------------------------------------
  return (
    <div className="max-w-5xl mx-auto space-y-6">
        {/* Nav & Actions */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
             <button 
                onClick={() => setActiveCategory(null)}
                className="text-gray-500 hover:text-brand-600 flex items-center text-sm font-medium transition"
             >
                 <ArrowLeft className="w-4 h-4 mr-1" /> Back to Boards
             </button>
             <div className="flex items-center justify-between md:justify-end flex-1">
                 <h2 className="text-xl font-bold text-gray-900 md:mr-4">{currentCategoryData?.title}</h2>
                 <button 
                    onClick={() => setIsCreatingThread(!isCreatingThread)}
                    className="bg-brand-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-brand-700 flex items-center shadow-sm"
                 >
                     {isCreatingThread ? <span className="flex items-center">Cancel</span> : <span className="flex items-center"><Plus className="w-4 h-4 mr-1"/> New Topic</span>}
                 </button>
             </div>
        </div>

        {/* Create Thread Form */}
        {isCreatingThread && (
            <div className="bg-white p-6 rounded-lg shadow-lg border border-gray-200 animate-fade-in">
                <h3 className="font-bold text-lg text-gray-900 mb-4 border-b pb-2">Start a New Discussion</h3>
                <form onSubmit={handleThreadSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Topic Title</label>
                        <input required type="text" value={newTitle} onChange={e => setNewTitle(e.target.value)} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-brand-500 focus:border-brand-500" placeholder="What is this discussion about?" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Content</label>
                        <textarea required value={newContent} onChange={e => setNewContent(e.target.value)} rows={6} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-brand-500 focus:border-brand-500" placeholder="Share your thoughts..."></textarea>
                    </div>
                    <div className="flex justify-end">
                        <button type="submit" className="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-brand-600 hover:bg-brand-700">
                            Post Thread
                        </button>
                    </div>
                </form>
            </div>
        )}

        {/* Thread List */}
        <div className="bg-white shadow rounded-lg overflow-hidden border border-gray-200">
             <div className="bg-gray-50 px-6 py-3 border-b border-gray-200 flex text-xs font-bold text-gray-500 uppercase tracking-wider">
                <div className="flex-1">Topic</div>
                <div className="w-32 text-center hidden sm:block">Replies</div>
                <div className="w-48 text-right hidden sm:block">Last Activity</div>
            </div>
            <div className="divide-y divide-gray-100">
                {filteredThreads.length > 0 ? filteredThreads.map(thread => {
                    const author = getUser(thread.authorId);
                    return (
                        <div key={thread.id} className="px-6 py-4 hover:bg-gray-50 transition">
                            <div className="flex items-center justify-between">
                                <div className="flex-1 pr-4">
                                    <Link to={`/forum/${thread.id}`} className="text-lg font-medium text-brand-600 hover:text-brand-800 block mb-1">
                                        {thread.title}
                                    </Link>
                                    <div className="flex items-center text-xs text-gray-500">
                                        <span className="flex items-center mr-3">
                                            <User className="w-3 h-3 mr-1" /> {author?.name || 'Unknown'}
                                        </span>
                                        <span className="flex items-center">
                                            <Clock className="w-3 h-3 mr-1" /> {new Date(Number(thread.id)).toLocaleDateString()}
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="w-32 text-center hidden sm:block">
                                    <div className="inline-flex items-center justify-center bg-gray-100 text-gray-600 font-bold px-3 py-1 rounded-full text-xs">
                                        <MessageCircle className="w-3 h-3 mr-1" />
                                        {thread.replies.length}
                                    </div>
                                </div>

                                <div className="w-48 text-right hidden sm:block pl-4 text-sm text-gray-500">
                                    {new Date(thread.lastActive).toLocaleString()}
                                </div>

                                <div className="sm:hidden pl-2">
                                    <Link to={`/forum/${thread.id}`}>
                                         <ChevronRight className="w-5 h-5 text-gray-400" />
                                    </Link>
                                </div>
                            </div>
                        </div>
                    );
                }) : (
                    <div className="p-10 text-center text-gray-500">
                        <p className="text-lg font-medium">No topics yet.</p>
                        <p className="text-sm">Be the first to start a discussion in this board!</p>
                    </div>
                )}
            </div>
        </div>
    </div>
  );
};

export default Forums;
