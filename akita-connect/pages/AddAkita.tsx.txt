import React, { useState } from 'react';
import { useStore } from '../context/StoreContext';
import { useNavigate } from 'react-router-dom';
import { Akita } from '../types';
import { generateAkitaBio } from '../services/gemini';
import { Sparkles } from 'lucide-react';

const AddAkita: React.FC = () => {
  const { addAkita, currentUser, akitas } = useStore();
  const navigate = useNavigate();
  
  const [formData, setFormData] = useState({
    name: '',
    registeredName: '',
    registrationNumber: '',
    dob: '',
    sex: 'Male',
    color: '',
    sireId: '',
    damId: '',
    about: '',
    avatar: 'https://images.unsplash.com/photo-1564425873683-e06978db8e39?auto=format&fit=crop&q=80&w=300' // Default placeholder
  });
  const [isGeneratingBio, setIsGeneratingBio] = useState(false);

  // Filter potential parents
  const potentialSires = akitas.filter(a => a.sex === 'Male');
  const potentialDams = akitas.filter(a => a.sex === 'Female');

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleGenerateBio = async () => {
      if(!formData.name) return;
      setIsGeneratingBio(true);
      const bio = await generateAkitaBio(formData.name, `${formData.sex} ${formData.color} Akita.`);
      if (bio) {
          setFormData(prev => ({ ...prev, about: bio }));
      }
      setIsGeneratingBio(false);
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const newAkita: Akita = {
      id: Date.now().toString(),
      ownerId: currentUser.id,
      name: formData.name,
      registeredName: formData.registeredName,
      registrationNumber: formData.registrationNumber,
      dob: formData.dob,
      sex: formData.sex as 'Male' | 'Female',
      color: formData.color,
      avatar: formData.avatar,
      sireId: formData.sireId || undefined,
      damId: formData.damId || undefined,
      healthRecords: [],
      achievements: [],
      titles: [],
      gallery: [],
      about: formData.about
    };
    addAkita(newAkita);
    navigate(`/akita/${newAkita.id}`);
  };

  return (
    <div className="max-w-2xl mx-auto bg-white shadow rounded-lg p-8">
      <h1 className="text-2xl font-bold text-gray-900 mb-6">Add a New Akita</h1>
      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Call Name</label>
                <input required type="text" name="name" value={formData.name} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g. Bear" />
            </div>
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Sex</label>
                <select name="sex" value={formData.sex} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option>Male</option>
                    <option>Female</option>
                </select>
            </div>
            <div className="sm:col-span-2">
                <label className="block text-sm font-medium text-gray-700">Registered Name</label>
                <input required type="text" name="registeredName" value={formData.registeredName} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g. Mountain Mist's Shadow" />
            </div>
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Registration #</label>
                <input type="text" name="registrationNumber" value={formData.registrationNumber} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
            </div>
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" name="dob" value={formData.dob} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
            </div>
            <div className="sm:col-span-2">
                <label className="block text-sm font-medium text-gray-700">Color / Markings</label>
                <input type="text" name="color" value={formData.color} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g. Red Fawn with Black Mask" />
            </div>
        </div>

        <div className="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2 border-t pt-4">
            <div className="sm:col-span-2 text-sm font-medium text-gray-500 uppercase tracking-wide">Pedigree Info</div>
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Sire (Father)</label>
                <select name="sireId" value={formData.sireId} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="">Select Sire</option>
                    {potentialSires.map(s => <option key={s.id} value={s.id}>{s.registeredName}</option>)}
                </select>
            </div>
            <div className="sm:col-span-1">
                <label className="block text-sm font-medium text-gray-700">Dam (Mother)</label>
                <select name="damId" value={formData.damId} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="">Select Dam</option>
                    {potentialDams.map(d => <option key={d.id} value={d.id}>{d.registeredName}</option>)}
                </select>
            </div>
        </div>

        <div className="border-t pt-4">
            <div className="flex justify-between items-center mb-1">
                <label className="block text-sm font-medium text-gray-700">Bio / Description</label>
                <button type="button" onClick={handleGenerateBio} disabled={isGeneratingBio || !formData.name} className="text-xs flex items-center text-brand-600 hover:text-brand-800 disabled:opacity-50">
                    <Sparkles className="w-3 h-3 mr-1" />
                    {isGeneratingBio ? 'Generating...' : 'Generate with AI'}
                </button>
            </div>
            <textarea 
                name="about" 
                rows={3} 
                value={formData.about} 
                onChange={handleChange} 
                className="block w-full border border-gray-300 rounded-md shadow-sm p-2"
                placeholder="Tell us about your dog..."
            ></textarea>
        </div>

        <div className="flex justify-end pt-4">
             <button type="submit" className="bg-brand-600 text-white px-6 py-2 rounded-md font-medium hover:bg-brand-700 shadow-sm">
                 Add Akita
             </button>
        </div>
      </form>
    </div>
  );
};

export default AddAkita;